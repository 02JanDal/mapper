#!/bin/sh -e
#
#    Copyright 2012 Kai Pastor
#    
#    This file is part of OpenOrienteering.
# 
#    OpenOrienteering is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
# 
#    OpenOrienteering is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
# 
#    You should have received a copy of the GNU General Public License
#    along with OpenOrienteering.  If not, see <http://www.gnu.org/licenses/>.

# sh wrapping:
# Especially MSYS needs -l so that it reads /etc/profile and sets up a proper
# environment. But /etc/profile will cd to the home directory. The wrapper needs
# to cd back to the BINARY_DIR. [2]
# In addition, configure must be called from its proper /[DRIVER_LETTER]/...
# path in MSYS, while CMAKE provides a [DRIVE_LETTER]:/... path. [1]

# [1] Get rid of DOS-style paths in MSYS
cd "@SOURCE_DIR@"
SOURCE_DIR=$(pwd)

# [2] Go to build directory
cd "@BINARY_DIR@"

# [3] Establish cross-compilation configuration
PLATFORM="@QT_PLATFORM@"
if [ -n "$PLATFORM" ]
then
	PLATFORM_ARG="-xplatform $PLATFORM"
	MKSPECS_DIR="@SOURCE_DIR@/mkspecs/$PLATFORM"
	if [ ! -d "$MKSPECS_DIR" -o -f "$MKSPECS_DIR/GENERATED" ]
	then
		mkdir -p "$MKSPECS_DIR"
		for I in qmake.conf qplatformdefs.h
		do
			cp "@CMAKE_CURRENT_BINARY_DIR@/$I.tmp" "$MKSPECS_DIR/$I"
		done
		touch "$MKSPECS_DIR/GENERATED"
	fi
fi

"$SOURCE_DIR/configure" \
  -opensource \
  -confirm-license \
  -fast \
  $PLATFORM_ARG \
  -release \
  -no-exceptions \
  -shared \
  -prefix "@INSTALL_DIR@" \
  -prefix-install \
  -script \
  -no-iconv \
  -opengl desktop \
  -webkit \
  -no-glib \
  -no-gstreamer \
  -no-phonon \
  -no-phonon-backend \
  -accessibility \
  -no-reduce-exports \
  -no-rpath \
  -make libs \
  -nomake demos \
  -nomake docs \
  -nomake examples \
  -make tools \
  -make translations \
  -no-qt3support \
  -no-xmlpatterns \
  -no-multimedia \
  -no-audio-backend \
  -no-script \
  -no-scripttools \
  -no-declarative \
  -qt-sql-sqlite \
  -no-sql-odbc \
  -no-sql-psql \
  -no-sql-tds \
  -qt-zlib \
  -qt-libpng \
  -qt-libjpeg \
  -qt-libtiff \
  -qt-libmng \
  -no-openssl \
  -no-dbus \
  -v
